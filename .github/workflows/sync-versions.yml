name: Sync Project Version with SHAFT Engine

# Triggers on pushes to main branch when pom.xml files are modified
on:
  push:
    branches: [ main ]
    paths: 
      - 'pom.xml'
      - 'src/main/resources/archetype-resources/pom.xml'
      - 'src/test/resources/projects/should-generate-project/reference/pom.xml'
  workflow_dispatch:

jobs:
  sync-versions:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          # Use a PAT to ensure the workflow can trigger other workflows
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'zulu'
          check-latest: true
          
      - name: Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.5

      - name: Extract versions from pom.xml files
        run: |
          # Get current project version and SHAFT Engine version from main pom.xml
          CURRENT_PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          
          # Extract SHAFT Engine version from archetype template
          SHAFT_ENGINE_VERSION=$(grep -o '<shaft_engine.version>[^<]*</shaft_engine.version>' src/main/resources/archetype-resources/pom.xml | sed 's/<shaft_engine.version>\(.*\)<\/shaft_engine.version>/\1/')
          
          echo "Current project version: $CURRENT_PROJECT_VERSION"
          echo "SHAFT Engine version in template: $SHAFT_ENGINE_VERSION"
          
          # Set environment variables
          echo "CURRENT_PROJECT_VERSION=$CURRENT_PROJECT_VERSION" >> $GITHUB_ENV
          echo "SHAFT_ENGINE_VERSION=$SHAFT_ENGINE_VERSION" >> $GITHUB_ENV
          
      - name: Check if versions need sync
        id: check_sync
        run: |
          if [ "$CURRENT_PROJECT_VERSION" != "$SHAFT_ENGINE_VERSION" ]; then
            echo "Versions are out of sync. Project: $CURRENT_PROJECT_VERSION, Engine: $SHAFT_ENGINE_VERSION"
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Versions are already in sync: $CURRENT_PROJECT_VERSION"
            echo "sync_needed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Update project version in main pom.xml
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          # Update project version to match SHAFT Engine version
          sed -i "/<artifactId>testng-archetype<\/artifactId>/,/<\/version>/ s|<version>$CURRENT_PROJECT_VERSION</version>|<version>$SHAFT_ENGINE_VERSION</version>|" pom.xml
          echo "Updated main pom.xml project version to $SHAFT_ENGINE_VERSION"
          
      - name: Update SHAFT Engine version in archetype template
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          # Update SHAFT Engine version in archetype template
          sed -i "s|<shaft_engine.version>.*</shaft_engine.version>|<shaft_engine.version>$SHAFT_ENGINE_VERSION</shaft_engine.version>|" src/main/resources/archetype-resources/pom.xml
          echo "Updated archetype template SHAFT Engine version to $SHAFT_ENGINE_VERSION"
          
      - name: Update SHAFT Engine version in test reference
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          # Update SHAFT Engine version in test reference
          sed -i "s|<shaft_engine.version>.*</shaft_engine.version>|<shaft_engine.version>$SHAFT_ENGINE_VERSION</shaft_engine.version>|" src/test/resources/projects/should-generate-project/reference/pom.xml
          echo "Updated test reference SHAFT Engine version to $SHAFT_ENGINE_VERSION"
          
      - name: Verify changes
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          echo "=== Changes made ==="
          git diff --name-only
          echo ""
          echo "=== Main POM version ==="
          grep -n "<version>" pom.xml | head -3
          echo ""
          echo "=== Archetype template engine version ==="
          grep -n "shaft_engine.version" src/main/resources/archetype-resources/pom.xml
          echo ""
          echo "=== Test reference engine version ==="
          grep -n "shaft_engine.version" src/test/resources/projects/should-generate-project/reference/pom.xml
          echo ""
          echo "=== Checking for old version references ==="
          OLD_VERSION_COUNT=$(grep -r "$CURRENT_PROJECT_VERSION" pom.xml src/main/resources/archetype-resources/pom.xml src/test/resources/projects/should-generate-project/reference/pom.xml | grep -v "using_shaft_engine" | grep -v "0.0.1" | wc -l || echo "0")
          if [ "$OLD_VERSION_COUNT" -eq "0" ]; then
            echo "âœ… No old version references found (expected)"
          else
            echo "âš ï¸  Found $OLD_VERSION_COUNT old version references:"
            grep -r "$CURRENT_PROJECT_VERSION" pom.xml src/main/resources/archetype-resources/pom.xml src/test/resources/projects/should-generate-project/reference/pom.xml | grep -v "using_shaft_engine" | grep -v "0.0.1"
          fi
          
      - name: Commit and push changes
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          # Configure git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Stage changes
          git add pom.xml src/main/resources/archetype-resources/pom.xml src/test/resources/projects/should-generate-project/reference/pom.xml
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Commit changes
            git commit -m "ðŸ”„ Auto-sync project version to $SHAFT_ENGINE_VERSION

            - Updated project version in main pom.xml
            - Updated SHAFT Engine version in archetype template  
            - Updated SHAFT Engine version in test reference
            
            This automated update keeps all version references in sync with the SHAFT Engine version."
            
            # Push changes
            git push
            echo "Changes committed and pushed successfully"
          fi
          
      - name: Create summary
        run: |
          if [ "${{ steps.check_sync.outputs.sync_needed }}" == "true" ]; then
            echo "âœ… **Version Sync Completed**" >> $GITHUB_STEP_SUMMARY
            echo "- Project version updated from \`$CURRENT_PROJECT_VERSION\` to \`$SHAFT_ENGINE_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- Updated files:" >> $GITHUB_STEP_SUMMARY
            echo "  - \`pom.xml\` (project version)" >> $GITHUB_STEP_SUMMARY
            echo "  - \`src/main/resources/archetype-resources/pom.xml\` (SHAFT Engine version)" >> $GITHUB_STEP_SUMMARY
            echo "  - \`src/test/resources/projects/should-generate-project/reference/pom.xml\` (SHAFT Engine version)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No Sync Needed**" >> $GITHUB_STEP_SUMMARY
            echo "- Project version (\`$CURRENT_PROJECT_VERSION\`) already matches SHAFT Engine version" >> $GITHUB_STEP_SUMMARY
          fi